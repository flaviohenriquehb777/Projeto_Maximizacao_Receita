name: commit-date-guard

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  guard-commit-dates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit dates between Jan–Jun 2022
        shell: bash
        run: |
          set -euo pipefail
          START="2022-01-01T00:00:00Z"
          END="2022-06-30T23:59:59Z"

          BEFORE_REF="${{ github.event.before }}"
          HEAD_REF="${{ github.sha }}"

          if [[ -z "${BEFORE_REF}" || "${BEFORE_REF}" == "0000000000000000000000000000000000000000" ]]; then
            COMMITS=$(git rev-list "${HEAD_REF}")
          else
            COMMITS=$(git rev-list "${BEFORE_REF}..${HEAD_REF}")
          fi

          start_s=$(date -d "$START" +%s)
          end_s=$(date -d "$END" +%s)

          echo "Checking commit date policy: $START .. $END"
          for c in ${COMMITS}; do
            a_date=$(git show -s --format=%aI "$c")
            c_date=$(git show -s --format=%cI "$c")
            a_s=$(date -d "$a_date" +%s)
            c_s=$(date -d "$c_date" +%s)

            if [[ $a_s -lt $start_s || $a_s -gt $end_s ]]; then
              echo "ERROR: Commit $c author date $a_date outside allowed range"
              exit 1
            fi
            if [[ $c_s -lt $start_s || $c_s -gt $end_s ]]; then
              echo "ERROR: Commit $c committer date $c_date outside allowed range"
              exit 1
            fi
            echo "OK: $c -> author=$a_date committer=$c_date"
          done

          echo "All commit dates comply with the Jan–Jun 2022 policy."